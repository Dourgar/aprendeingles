<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendiendo Inglés con Douglas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .prose a {
            color: #2b6cb0;
            text-decoration: underline;
        }
        .prose a:hover {
            color: #1e4b85;
        }
        /* Estilos del Quiz */
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .option-button.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .multiple-select-option:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .multiple-select-option.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.5);
            accent-color: #6366f1;
        }
        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca);
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81);
            transform: translateY(-4px);
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
            background-image: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800;
            color: #4338ca;
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto;
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626;
            background-color: #fee2e2;
        }
        .multi-part-question-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .multi-part-question-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .multi-part-question-item label {
            font-weight: 600;
            color: #4a5568;
        }
        .module-selection-card {
            background-color: #f0f4f8;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .module-selection-card select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 0.75rem;
            border: 2px solid #e0e7ee;
            background-color: #ffffff;
            color: #3f4a5a;
        }
        .module-selection-card select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .attempts-counter {
            font-weight: 600;
            margin-top: 1rem;
        }
        .disabled-module-link {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <nav id="mainNav" class="bg-gradient-to-r from-blue-600 to-blue-800 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-white text-3xl font-bold tracking-wide">Aprendiendo Inglés con Douglas</a>
            <div id="navButtons" class="space-x-4">
                <button id="navLoginBtn" class="bg-white text-blue-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-200 transition duration-300 shadow-md">Iniciar Sesión</button>
                <button id="navRegisterBtn" class="bg-green-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-green-600 transition duration-300 shadow-md">Inscribirse</button>
            </div>
        </div>
    </nav>

    <div id="mainContent">

        <section id="introSection" class="relative bg-gradient-to-br from-blue-500 to-indigo-600 text-white py-20 px-4 text-center shadow-inner">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="relative z-10 container mx-auto">
                <h1 class="text-5xl md:text-6xl font-extrabold leading-tight mb-6 animate-fade-in-down">¡Desbloquea tu Potencial en Inglés!</h1>
                <p class="text-xl md:text-2xl mb-10 max-w-3xl mx-auto opacity-90 animate-fade-in-up">Sumérgete en un viaje fascinante para dominar el inglés de forma práctica y divertida. ¡Tu aventura comienza aquí!</p>
                <button id="startLearningBtn" class="bg-yellow-400 text-blue-900 py-4 px-10 rounded-full text-xl font-bold uppercase hover:bg-yellow-500 transition duration-300 transform hover:scale-105 shadow-lg">Comienza a Aprender Hoy</button>
            </div>
        </section>

        <section id="quizInstructionsSection" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Instrucciones de la Prueba</h2>
                <div class="prose max-w-none text-gray-700">
                    <p class="text-lg">¡Bienvenido al quiz de inglés! A continuación, se detallan las reglas para completar la prueba:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li>La prueba tiene una duración máxima de **20 minutos**.</li>
                        <li>Una vez iniciada la prueba, el tiempo no se detiene.</li>
                        <li>Debes responder todas las preguntas para poder avanzar.</li>
                        <li>En las preguntas de selección múltiple, se te dará una puntuación parcial por cada respuesta correcta.</li>
                        <li>Solo tienes un máximo de **2 intentos** para presentar la prueba.</li>
                        <li>Los resultados te serán enviados por correo electrónico, al igual que un mensaje al administrador.</li>
                    </ul>
                    <p class="text-lg font-bold mt-4">¡Mucho éxito!</p>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="openQuizStartModalBtn" class="main-button">Comenzar</button>
                </div>
            </div>
        </section>

        <div id="quiz-app-container" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div id="quiz-app" class="bg-white p-8 rounded-lg shadow-lg"></div>
        </div>
    </div>

    <div id="quizStartModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeQuizStartModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Comenzar la Prueba</h2>
            <form id="quizStartForm" class="space-y-5">
                <div>
                    <label for="quizNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="quizNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="quizEmail" class="block text-gray-700 text-lg font-medium mb-2">Correo Electrónico:</label>
                    <input type="email" id="quizEmail" name="email" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="quizStartBtnText">Iniciar Prueba</span>
                    <span id="quizStartSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <p id="quizAttemptsMessage" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>

    <div id="registerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeRegisterModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Formulario de Inscripción</h2>
            <form id="registrationForm" class="space-y-5">
                <div>
                    <label for="regNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="regNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="regCedula" class="block text-gray-700 text-lg font-medium mb-2">Cédula de Identidad:</label>
                    <input type="text" id="regCedula" name="cedula" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="regEdad" class="block text-gray-700 text-lg font-medium mb-2">Edad:</label>
                    <input type="number" id="regEdad" name="edad" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required min="10" max="100">
                </div>
                <div>
                    <label for="regEmail" class="block text-gray-700 text-lg font-medium mb-2">Correo Electrónico:</label>
                    <input type="email" id="regEmail" name="correo" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="registrationBtnText">Inscribirme</span>
                    <span id="registrationSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <div id="registerMessage" class="text-center text-red-500 mt-4 font-medium" style="display:none;"></div>
            </form>
        </div>
    </div>

    <div id="final-thanks-message" class="hidden">
        ¡Gracias por completar el quiz!<br><br>
        Tus resultados serán enviados a tu correo electrónico.<br><br>
        <button id="backToHomeBtn" class="send-button mt-6">Volver a Inicio</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ⚠️ REEMPLAZA ESTA URL CON LA URL DE TU NUEVA IMPLEMENTACIÓN DE APPS SCRIPT
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydEMXaTklCoO11RZ1lR9zieXehlVFX7g8v8AQArdClxdITOH1KoBajYSxETv39KrKW/exec';
        
            const QUIZ_DURATION_SECONDS = 20 * 60; // 20 minutos
            let timerInterval;
            let elapsedSeconds = 0;
            let quizStartTime;
        
            const quizData = [
                { question: "Presentación y saludos (formal/informal)<br>Which of the following are informal greetings? (Select all that apply) / ¿Cuáles de las siguientes son saludos informales? (Selecciona todas las que apliquen):", options: ["a) Good morning", "b) How do you do?", "c) What’s up?", "d) Nice to meet you", "e) Hey!", "f) Goodbye", "g) What's new?"], quizType: "multiple-select" },
                { question: "Verbo “To be” (presente)<br>Completa la oración: 'He _______ a doctor.' con la forma correcta del verbo 'to be'", options: ["a) am", "b) are", "c) is", "d) be"], quizType: "single-choice" },
                { question: "Adjetivos Posesivos<br>Completa la oración: 'This is ___ car. (He)' con el adjetivo posesivo correcto.", quizType: "multi-direct-answer" },
                { question: "Días de la semana<br>La traducción correcta de 'Lunes' es 'Monday'.", options: ["true", "false"], quizType: "true-false" },
                { question: "Despedidas<br>Select the appropriate ways to say goodbye. / Selecciona las formas en que podemos despedirnos (Escoge todas las que apliquen):", options: ["a) See you later!", "b) Bye!", "c) Have a good day", "d) How are you?", "e) Good night", "f) See you tomorrow", "g) Hi"], quizType: "multiple-select" },
                { question: "Días de la semana<br>Select the correct order. / Selecciona el orden correcto:", options: ["a) Monday, Sunday, Tuesday", "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday", "c) Sunday, Tuesday, Monday"], quizType: "single-choice" },
                { question: "Artículos A - AN<br>Completa la oración: 'It's ___ apple.' con el artículo correcto.", quizType: "multi-direct-answer" },
                { question: "Pronombres Personales<br>'Nosotros' se traduce como 'We'.", options: ["true", "false"], quizType: "true-false" },
                { question: "Meses del año<br>Which of these are months of the year? (Select all that apply) / ¿Cuáles de estos son meses del año? (Selecciona todas las que apliquen):", options: ["a) January", "b) Winter", "c) Spring", "d) July", "e) December", "f) Monday", "g) November"], quizType: "multiple-select" },
                { question: "Números cardinales y ordinales<br>Choose the correct ordinal numbers. / Escoge los números ordinales:", options: ["a) First", "b) Three", "c) Third", "d) Seven", "e) Fifth", "f) Second", "g) Six"], quizType: "multiple-select" },
                { question: "Verbo “To be” (presente)<br>La traducción de la oración 'Ellos son mis amigos' es 'They are my friends'.", options: ["true", "false"], quizType: "true-false" },
                { question: "Números Cardinales<br>Traduce los siguientes números: 1, 2, 3, 4, 5.", quizType: "multi-direct-answer" },
                { question: "Artículos A - AN<br>'An' se usa antes de una palabra que comienza con una vocal.", options: ["true", "false"], quizType: "true-false" },
                { question: "Preguntas con “To be”<br>Reorganiza las palabras para formar una pregunta correcta: a good student / you / are", quizType: "multi-direct-answer" }
            ];
        
            // Variables de estado
            let currentUserEmail = '';
            let currentUserFullName = '';
        
            // --- Funciones de control de la UI ---
            function showSection(sectionId) {
                document.querySelectorAll('section, div[id$="Modal"], div[id$="container"], #final-thanks-message').forEach(el => {
                    if (!el.classList.contains('hidden')) {
                        el.classList.add('hidden');
                    }
                });
                document.getElementById(sectionId).classList.remove('hidden');
            }
        
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                }, 10);
            }
        
            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            
            function setButtonLoadingState(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    const textSpan = button.querySelector('span:not(.loading-spinner)');
                    const spinnerSpan = button.querySelector('.loading-spinner');
                    button.disabled = isLoading;
                    if (textSpan) {
                        textSpan.style.display = isLoading ? 'none' : 'inline';
                    }
                    if (spinnerSpan) {
                        spinnerSpan.style.display = isLoading ? 'inline-block' : 'none';
                    }
                } else {
                    console.error(`Button with ID '${buttonId}' not found.`);
                }
            }
            
            // --- Funciones de manejo del Quiz ---
            function renderQuestions() {
                const quizApp = document.getElementById('quiz-app');
                quizApp.innerHTML = '';
                
                const quizContent = document.createElement('div');
                quizContent.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-blue-700">Quiz de Nivelación</h2>
                        <div id="quizTimer" class="timer-display">20:00</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="quizProgressBar" class="progress-bar"></div>
                    </div>
                    <div id="quizQuestionsContainer" class="space-y-6 mt-6"></div>
                    <div class="flex justify-end mt-8">
                        <button id="submitQuizBtn" class="send-button">Enviar Resultados</button>
                    </div>
                `;
                quizApp.appendChild(quizContent);
                
                const questionsContainer = document.getElementById('quizQuestionsContainer');
                quizData.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('quiz-question', 'p-6', 'bg-gray-50', 'rounded-lg', 'shadow-sm');
                    let optionsHtml = '';
                    
                    if (question.quizType === 'multi-direct-answer') {
                        const numInputs = question.question.includes('1, 2, 3, 4, 5') ? 5 : 1;
                        let inputsHtml = '';
                        if (numInputs > 1) {
                            inputsHtml = `<div class="multi-part-question-container">`;
                            for (let i = 0; i < numInputs; i++) {
                                inputsHtml += `<input type="text" name="q${index}_${i}" class="direct-answer-input" placeholder="Respuesta ${i + 1}">`;
                            }
                            inputsHtml += `</div>`;
                        } else {
                            inputsHtml = `<input type="text" name="q${index}_0" class="direct-answer-input" placeholder="Escribe tu respuesta aquí...">`;
                        }
                        optionsHtml = inputsHtml;
                    } else if (question.quizType === 'multiple-select') {
                        optionsHtml = question.options.map((option, i) => `
                            <label class="multiple-select-option">
                                <input type="checkbox" name="q${index}" value="${String.fromCharCode(97 + i)}" class="mr-3 transform scale-125">
                                <span class="ml-2">${option}</span>
                            </label>
                        `).join('');
                    } else { // single-choice and true-false
                        optionsHtml = question.options.map((option, i) => `
                            <button type="button" class="option-button" data-question-index="${index}" data-value="${option.split(')')[0].toLowerCase().trim()}">
                                ${option}
                            </button>
                        `).join('');
                    }
        
                    questionElement.innerHTML = `
                        <p class="font-bold text-lg mb-4 text-blue-600">${index + 1}.</p>
                        <p class="text-base leading-relaxed mb-4">${question.question}</p>
                        <div class="space-y-3 mt-2">${optionsHtml}</div>
                    `;
                    questionsContainer.appendChild(questionElement);
                });
        
                // Event listeners para botones de single-choice y true-false
                questionsContainer.querySelectorAll('.option-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const questionIndex = button.dataset.questionIndex;
                        const value = button.dataset.value;
                        const questionButtons = questionsContainer.querySelectorAll(`[data-question-index="${questionIndex}"]`);
                        questionButtons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                    });
                });
                
                // Event listeners para botones de multiple-select
                questionsContainer.querySelectorAll('.multiple-select-option').forEach(label => {
                    label.addEventListener('click', () => {
                        const checkbox = label.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        label.classList.toggle('selected', checkbox.checked);
                    });
                });
        
                document.getElementById('submitQuizBtn').addEventListener('click', finishQuiz);
            }
            
            function startQuiz() {
                showSection('quiz-app-container');
                renderQuestions();
                startTimer();
                quizStartTime = new Date();
            }
            
            function startTimer() {
                const timerDisplay = document.getElementById('quizTimer');
                const progressBar = document.getElementById('quizProgressBar');
                timerInterval = setInterval(() => {
                    elapsedSeconds++;
                    const remainingTime = QUIZ_DURATION_SECONDS - elapsedSeconds;
        
                    if (remainingTime <= 0) {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = '00:00';
                        finishQuiz();
                        return;
                    }
        
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    timerDisplay.textContent = formattedTime;
        
                    if (remainingTime <= 60) {
                        timerDisplay.classList.add('low-time');
                    }
        
                    const progressPercentage = (elapsedSeconds / QUIZ_DURATION_SECONDS) * 100;
                    progressBar.style.width = `${progressPercentage}%`;
                }, 1000);
            }
            
            function getFormData() {
                const userAnswers = [];
                const quizQuestions = document.getElementById('quizQuestionsContainer').children;
                quizData.forEach((question, index) => {
                    const type = question.quizType;
                    let selectedAnswer;
        
                    if (type === 'multiple-select') {
                        const checkboxes = quizQuestions[index].querySelectorAll('input[type="checkbox"]:checked');
                        selectedAnswer = Array.from(checkboxes).map(checkbox => checkbox.value);
                    } else if (type === 'multi-direct-answer') {
                         const inputs = quizQuestions[index].querySelectorAll('input[type="text"]');
                         selectedAnswer = Array.from(inputs).map(input => input.value.toLowerCase().trim());
                    } else if (type === 'single-choice' || type === 'true-false') {
                        const selectedButton = quizQuestions[index].querySelector('.option-button.selected');
                        selectedAnswer = selectedButton ? selectedButton.dataset.value : null;
                    }
                    userAnswers.push(selectedAnswer);
                });
                return userAnswers;
            }
            
            function finishQuiz() {
                clearInterval(timerInterval);
                const userAnswers = getFormData();
                const quizEndTime = new Date();
                const responseTime = (quizEndTime - quizStartTime) / 1000;
                
                const submissionData = {
                    type: 'quiz_results',
                    fullName: currentUserFullName,
                    email: currentUserEmail,
                    userAnswers: userAnswers,
                    responseTime: formatElapsedTime(responseTime)
                };
        
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(submissionData),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                     // Apps Script siempre devuelve un 200, la respuesta exitosa está en el cuerpo JSON
                     return response.text();
                })
                .then(data => {
                    console.log('Quiz results submitted. Server response:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    // Muestra el mensaje de agradecimiento
                    const finalMessage = document.getElementById('final-thanks-message');
                    finalMessage.classList.remove('hidden');
                    setTimeout(() => finalMessage.classList.add('show'), 10);
                    
                    // Oculta el contenedor del quiz y la barra de navegación
                    document.getElementById('quiz-app-container').classList.add('hidden');
                    document.getElementById('mainNav').classList.add('hidden');
                });
            }
        
            function formatElapsedTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.round(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        
            // --- Funciones de manejo de Eventos de la UI ---
            // Botones de la barra de navegación
            document.getElementById('navLoginBtn').addEventListener('click', () => showModal('quizStartModal'));
            document.getElementById('navRegisterBtn').addEventListener('click', () => showModal('registerModal'));
            
            // Botón de la sección de inicio
            document.getElementById('startLearningBtn').addEventListener('click', () => showSection('quizInstructionsSection'));
        
            // Botones para abrir/cerrar modales
            document.getElementById('openQuizStartModalBtn').addEventListener('click', () => {
                showModal('quizStartModal');
                document.getElementById('quizAttemptsMessage').textContent = ''; // Limpiar mensaje de intentos
            });
            document.getElementById('closeQuizStartModal').addEventListener('click', () => hideModal('quizStartModal'));
            document.getElementById('closeRegisterModal').addEventListener('click', () => hideModal('registerModal'));
        
            // Botón para volver a inicio
            document.getElementById('backToHomeBtn').addEventListener('click', () => window.location.reload());
            
            // --- Manejo de Formularios ---
            // Formulario de Inscripción
            document.getElementById('registrationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                setButtonLoadingState('registrationBtnText', true);
        
                const formData = new FormData(this);
                const submissionData = {
                    type: 'inscription',
                    nombre: formData.get('nombre'),
                    cedula: formData.get('cedula'),
                    edad: formData.get('edad'),
                    correo: formData.get('correo'),
                };
        
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(submissionData),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    const messageElement = document.getElementById('registerMessage');
                    if (data.success) {
                        messageElement.textContent = 'Inscripción exitosa. Revisa tu correo.';
                        messageElement.classList.remove('text-red-500');
                        messageElement.classList.add('text-green-500');
                        messageElement.style.display = 'block';
                        document.getElementById('registrationForm').reset();
                    } else {
                        messageElement.textContent = data.message;
                        messageElement.classList.remove('text-green-500');
                        messageElement.classList.add('text-red-500');
                        messageElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const messageElement = document.getElementById('registerMessage');
                    messageElement.textContent = 'Ocurrió un error de red. Intenta de nuevo.';
                    messageElement.classList.remove('text-green-500');
                    messageElement.classList.add('text-red-500');
                    messageElement.style.display = 'block';
                })
                .finally(() => {
                    setButtonLoadingState('registrationBtnText', false);
                });
            });
        
            // Formulario de Inicio de Quiz
            document.getElementById('quizStartForm').addEventListener('submit', function(e) {
                e.preventDefault();
                setButtonLoadingState('quizStartBtnText', true);
        
                const fullName = document.getElementById('quizNombre').value;
                const email = document.getElementById('quizEmail').value;
                const quizAttemptsMessage = document.getElementById('quizAttemptsMessage');
                
                // Almacenar el nombre y correo para el envío final
                currentUserEmail = email;
                currentUserFullName = fullName;
        
                // Verificar el estado del usuario con el script de Apps Script (doGet)
                fetch(`${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.isRegistered === true) {
                            if (data.attempts >= 2) {
                                quizAttemptsMessage.textContent = 'Has alcanzado el número máximo de intentos (2).';
                                quizAttemptsMessage.classList.remove('hidden');
                                setButtonLoadingState('quizStartBtnText', false);
                            } else {
                                hideModal('quizStartModal');
                                showSection('quizInstructionsSection');
                                setButtonLoadingState('quizStartBtnText', false);
                            }
                        } else {
                            quizAttemptsMessage.textContent = 'El correo electrónico no está registrado.';
                            quizAttemptsMessage.classList.remove('hidden');
                            setButtonLoadingState('quizStartBtnText', false);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        quizAttemptsMessage.textContent = 'Error al verificar el correo. Intenta de nuevo.';
                        quizAttemptsMessage.classList.remove('hidden');
                        setButtonLoadingState('quizStartBtnText', false);
                    });
            });
        });
    </script>
</body>
</html>
