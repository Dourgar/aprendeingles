<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendiendo Inglés con Douglas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .prose a {
            color: #2b6cb0;
            text-decoration: underline;
        }
        .prose a:hover {
            color: #1e4b85;
        }
        /* Estilos del Quiz */
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .option-button.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .multiple-select-option:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .multiple-select-option.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.5);
            accent-color: #6366f1;
        }
        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca);
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81);
            transform: translateY(-4px);
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
            background-image: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800;
            color: #4338ca;
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto;
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626;
            background-color: #fee2e2;
        }
        .multi-part-question-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .multi-part-question-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .multi-part-question-item label {
            font-weight: 600;
            color: #4a5568;
        }
        .module-selection-card {
            background-color: #f0f4f8;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .module-selection-card select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 0.75rem;
            border: 2px solid #e0e7ee;
            background-color: #ffffff;
            color: #3f4a5a;
        }
        .module-selection-card select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .attempts-counter {
            font-weight: 600;
            margin-top: 1rem;
        }
        .disabled-module-link {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <nav id="mainNav" class="bg-gradient-to-r from-blue-600 to-blue-800 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-white text-3xl font-bold tracking-wide">Aprendiendo Inglés con Douglas</a>
            <div id="navButtons" class="space-x-4">
                <button id="navLoginBtn" class="bg-white text-blue-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-200 transition duration-300 shadow-md">Iniciar Sesión</button>
                <button id="navRegisterBtn" class="bg-green-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-green-600 transition duration-300 shadow-md">Inscribirse</button>
            </div>
        </div>
    </nav>

    <div id="mainContent">

        <section id="introSection" class="relative bg-gradient-to-br from-blue-500 to-indigo-600 text-white py-20 px-4 text-center shadow-inner">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="relative z-10 container mx-auto">
                <h1 class="text-5xl md:text-6xl font-extrabold leading-tight mb-6 animate-fade-in-down">¡Desbloquea tu Potencial en Inglés!</h1>
                <p class="text-xl md:text-2xl mb-10 max-w-3xl mx-auto opacity-90 animate-fade-in-up">Sumérgete en un viaje fascinante para dominar el inglés de forma práctica y divertida. ¡Tu aventura comienza aquí!</p>
                <button id="startLearningBtn" class="bg-yellow-400 text-blue-900 py-4 px-10 rounded-full text-xl font-bold uppercase hover:bg-yellow-500 transition duration-300 transform hover:scale-105 shadow-lg">Comienza a Aprender Hoy</button>
            </div>
        </section>
        
        <section id="quizInstructionsSection" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Instrucciones de la Prueba</h2>
                <div class="prose max-w-none text-gray-700">
                    <p class="text-lg">¡Bienvenido al quiz de inglés! A continuación, se detallan las reglas para completar la prueba:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li>La prueba tiene una duración máxima de **20 minutos**.</li>
                        <li>Una vez iniciada la prueba, el tiempo no se detiene.</li>
                        <li>Debes responder todas las preguntas para poder avanzar.</li>
                        <li>En las preguntas de selección múltiple, se te dará una puntuación parcial por cada respuesta correcta.</li>
                        <li>Solo tienes un máximo de **2 intentos** para presentar la prueba.</li>
                        <li>Los resultados te serán enviados por correo electrónico, al igual que un mensaje al administrador.</li>
                    </ul>
                    <p class="text-lg font-bold mt-4">¡Mucho éxito!</p>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="openQuizStartModalBtn" class="main-button">Comenzar</button>
                </div>
            </div>
        </section>

        <div id="quiz-app-container" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div id="quiz-app" class="bg-white p-8 rounded-lg shadow-lg"></div>
        </div>
    </div>
    
    <div id="quizStartModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeQuizStartModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Comenzar la Prueba</h2>
            <form id="quizStartForm" class="space-y-5">
                <div>
                    <label for="quizNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="quizNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="quizCorreo" class="block text-gray-700 text-lg font-medium mb-2">Correo Electrónico:</label>
                    <input type="email" id="quizCorreo" name="correo" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="quizStartBtnText">Iniciar Prueba</span>
                    <span id="quizStartSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <p id="quizAttemptsMessage" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>
    
    <div id="registerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeRegisterModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Formulario de Inscripción</h2>
            <form id="registrationForm" class="space-y-5">
                <div>
                    <label for="regNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="regNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="regCorreo" class="block text-gray-700 text-lg font-medium mb-2">Correo Electrónico:</label>
                    <input type="email" id="regCorreo" name="correo" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="registrationBtnText">Inscribirme</span>
                    <span id="registrationSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <div id="registerMessage" class="text-center text-red-500 mt-4 font-medium" style="display:none;"></div>
            </form>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhe-a_Wv5kAyFdbpm3iVCmpjyq34osMaW86NatNEy-Nny8N6RFBK4Kn-NBNYlA70iB4A/exec";
            const QUIZ_DURATION_SECONDS = 1200; // 20 minutos
            
            const allQuestions = [
                {
                    question: "Presentación y saludos (formal/informal)<br>Which of the following are informal greetings? (Select all that apply) / ¿Cuáles de las siguientes son saludos informales? (Selecciona todas las que apliquen):",
                    type: "multiple-select",
                    options: [
                        { text: "a) Hi", value: "a" },
                        { text: "b) Good evening", value: "b" },
                        { text: "c) Morning", value: "c" },
                        { text: "d) Hello", value: "d" },
                        { text: "e) How’s everything?", value: "e" },
                        { text: "f) Good morning", value: "f" },
                        { text: "g) How’s it going?", value: "g" }
                    ]
                },
                {
                    question: "Verbo “To be” (presente)<br>Completa la oración: 'He _______ a doctor.' con la forma correcta del verbo 'to be'",
                    type: "single-choice",
                    options: ["is", "am", "are"]
                },
                {
                    question: "Adjetivos Posesivos<br>Completa la oración: 'This is ___ car. (He)' con el adjetivo posesivo correcto.",
                    type: "multi-direct-answer",
                    parts: [{ prompt: "This is ___ car. (He)", type: "text" }]
                },
                {
                    question: "Días de la semana<br>La traducción correcta de 'Lunes' es 'Monday'.",
                    type: "true-false"
                },
                {
                    question: "Despedidas<br>Select the appropriate ways to say goodbye. / Selecciona las formas en que podemos despedirnos (Escoge todas las que apliquen):",
                    type: "multiple-select",
                    options: [
                        { text: "a) Bye", value: "a" },
                        { text: "b) See you later", value: "b" },
                        { text: "c) Good night", value: "c" },
                        { text: "d) Hello", value: "d" },
                        { text: "e) What’s up?", value: "e" },
                        { text: "f) How do you do?", value: "f" },
                        { text: "g) Good morning", value: "g" }
                    ]
                },
                {
                    question: "Días de la semana<br>Select the correct order. / Selecciona el orden correcto:",
                    type: "single-choice",
                    options: [
                        "a) Wednesday, Monday, Tuesday, Thursday, Friday, Saturday, Sunday",
                        "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday",
                        "c) Monday, Thursday, Wednesday, Tuesday, Friday, Saturday, Sunday",
                        "d) Monday, Tuesday, Wednesday, Thursday, Friday, Sunday, Saturday"
                    ]
                },
                {
                    question: "Artículos A - AN<br>Completa la oración: 'It's ___ apple.' con el artículo correcto.",
                    type: "multi-direct-answer",
                    parts: [{ prompt: "It's ___ apple.", type: "text" }]
                },
                {
                    question: "Pronombres Personales<br>'Nosotros' se traduce como 'We'.",
                    type: "true-false"
                },
                {
                    question: "Meses del año<br>Which of these are months of the year? (Select all that apply) / ¿Cuáles de estos son meses del año? (Selecciona todas las que apliquen):",
                    type: "multiple-select",
                    options: [
                        { text: "a) January", value: "a" },
                        { text: "b) Morning", value: "b" },
                        { text: "c) Saturday", value: "c" },
                        { text: "d) April", value: "d" },
                        { text: "e) Friday", value: "e" },
                        { text: "f) December", value: "f" },
                        { text: "g) August", value: "g" }
                    ]
                },
                {
                    question: "Números cardinales y ordinales<br>Choose the correct ordinal numbers. / Escoge los números ordinales:",
                    type: "multiple-select",
                    options: [
                        { text: "a) First", value: "a" },
                        { text: "b) Three", value: "b" },
                        { text: "c) Second", value: "c" },
                        { text: "d) Twelve", "value": "d" },
                        { text: "e) Third", value: "e" },
                        { text: "f) Fifth", value: "f" },
                        { text: "g) Eighteen", value: "g" }
                    ]
                },
                {
                    question: "Verbo “To be” (presente)<br>La traducción de la oración 'Ellos son mis amigos' es 'They are my friends'.",
                    type: "true-false"
                },
                {
                    question: "Números Cardinales<br>Traduce los siguientes números:",
                    type: "multi-direct-answer",
                    parts: [
                        { prompt: "1. Uno", type: "text" },
                        { prompt: "2. Dos", type: "text" },
                        { prompt: "3. Tres", type: "text" },
                        { prompt: "4. Cuatro", type: "text" },
                        { prompt: "5. Cinco", type: "text" }
                    ]
                },
                {
                    question: "Artículos A - AN<br>'An' se usa antes de una palabra que comienza con una vocal.",
                    type: "true-false"
                },
                {
                    question: "Preguntas con “To be”<br>Rearrange the words to form a correct question. / Reorganiza las palabras para formar una pregunta correcta: a good student / you / are",
                    type: "multi-direct-answer",
                    parts: [
                        { prompt: "1. a good student / you / are", type: "text" }
                    ]
                }
            ];

            const userAnswers = new Array(allQuestions.length).fill(null);
            let currentQuestionIndex = 0;
            let timerInterval;
            let startTime;
            let isQuizActive = false;
            let quizUserDetails = {};
            
            const introSection = document.getElementById('introSection');
            const startLearningBtn = document.getElementById('startLearningBtn');
            const quizInstructionsSection = document.getElementById('quizInstructionsSection');
            const openQuizStartModalBtn = document.getElementById('openQuizStartModalBtn');
            const quizAppContainer = document.getElementById('quiz-app-container');
            const quizApp = document.getElementById('quiz-app');
            const navRegisterBtn = document.getElementById('navRegisterBtn');
            const registerModal = document.getElementById('registerModal');
            const closeRegisterModalBtn = document.getElementById('closeRegisterModal');
            const quizStartModal = document.getElementById('quizStartModal');
            const closeQuizStartModalBtn = document.getElementById('closeQuizStartModal');
            const registrationForm = document.getElementById('registrationForm');
            const registerMessage = document.getElementById('registerMessage');
            const registrationSpinner = document.getElementById('registrationSpinner');
            const registrationBtnText = document.getElementById('registrationBtnText');
            const quizStartForm = document.getElementById('quizStartForm');
            const quizAttemptsMessage = document.getElementById('quizAttemptsMessage');
            const quizCorreoInput = document.getElementById('quizCorreo');

            function toggleModal(modalId, show) {
                const modal = document.getElementById(modalId);
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('scale-95'), 10);
                } else {
                    modal.classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            navRegisterBtn.addEventListener('click', () => {
                toggleModal('registerModal', true);
            });
            
            closeRegisterModalBtn.addEventListener('click', () => {
                toggleModal('registerModal', false);
            });
            
            closeQuizStartModalBtn.addEventListener('click', () => {
                toggleModal('quizStartModal', false);
            });

            window.addEventListener('click', (event) => {
                if (event.target === registerModal) {
                    toggleModal('registerModal', false);
                }
                if (event.target === quizStartModal) {
                    toggleModal('quizStartModal', false);
                }
            });

            registrationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                registrationBtnText.style.display = 'none';
                registrationSpinner.style.display = 'inline-block';
                const formData = new FormData(registrationForm);
                const data = Object.fromEntries(formData.entries());
                data.type = 'inscription';

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        registerMessage.textContent = '¡Inscripción exitosa! Serás notificado por correo electrónico.';
                        registerMessage.className = 'mt-4 text-center text-lg font-medium text-green-600';
                        registerMessage.style.display = 'block';
                        registrationForm.reset();
                    } else {
                        registerMessage.textContent = 'Error: ' + (result.message || 'El correo electrónico ya está registrado.');
                        registerMessage.className = 'mt-4 text-center text-lg font-medium text-red-600';
                        registerMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error en la solicitud de inscripción:', error);
                    registerMessage.textContent = 'Ocurrió un error al procesar la inscripción.';
                    registerMessage.className = 'mt-4 text-center text-lg font-medium text-red-600';
                    registerMessage.style.display = 'block';
                } finally {
                    registrationSpinner.style.display = 'none';
                    registrationBtnText.style.display = 'inline-block';
                }
            });

            // Lógica del Quiz
            startLearningBtn.addEventListener('click', () => {
                introSection.classList.add('hidden');
                quizInstructionsSection.classList.remove('hidden');
            });
            
            openQuizStartModalBtn.addEventListener('click', () => {
                 toggleModal('quizStartModal', true);
            });
            
            quizCorreoInput.addEventListener('blur', async () => {
                const email = quizCorreoInput.value;
                if (email) {
                    const checkAttemptsUrl = `${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}`;
                    try {
                        const response = await fetch(checkAttemptsUrl);
                        const result = await response.json();
                        if (result.isRegistered === false) {
                            quizAttemptsMessage.textContent = 'Este correo no está registrado. Por favor, inscríbete primero.';
                            quizAttemptsMessage.classList.remove('hidden');
                            document.getElementById('quizStartForm').querySelector('button').disabled = true;
                        } else if (result.attempts >= 2) {
                            quizAttemptsMessage.textContent = 'Ya has completado tus 2 intentos para esta prueba.';
                            quizAttemptsMessage.classList.remove('hidden');
                            document.getElementById('quizStartForm').querySelector('button').disabled = true;
                        } else {
                            quizAttemptsMessage.classList.add('hidden');
                            document.getElementById('quizStartForm').querySelector('button').disabled = false;
                        }
                    } catch (error) {
                        console.error('Error al verificar intentos:', error);
                        quizAttemptsMessage.textContent = 'Error al verificar intentos. Intenta de nuevo.';
                        quizAttemptsMessage.classList.remove('hidden');
                    }
                }
            });

            quizStartForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(quizStartForm);
                quizUserDetails.fullName = formData.get('nombre');
                quizUserDetails.email = formData.get('correo');
                toggleModal('quizStartModal', false);
                startQuiz();
            });

            function startQuiz() {
                quizInstructionsSection.classList.add('hidden');
                quizAppContainer.classList.remove('hidden');
                startTime = new Date();
                isQuizActive = true;
                renderQuestion();
                startTimer();
            }

            function renderQuestion() {
                if (currentQuestionIndex >= allQuestions.length) {
                    finishQuiz();
                    return;
                }

                const questionData = allQuestions[currentQuestionIndex];
                let questionHtml = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-xl font-bold text-indigo-700">Ítem ${currentQuestionIndex + 1} de ${allQuestions.length}</div>
                        <div id="quizTimer" class="timer-display">00:00</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${((currentQuestionIndex + 1) / allQuestions.length) * 100}%;"></div>
                    </div>
                    <div class="mt-8 text-2xl font-bold text-gray-800 leading-relaxed mb-6">${questionData.question}</div>
                `;

                if (questionData.type === 'single-choice') {
                    questionHtml += `<div id="options-container" class="space-y-4">`;
                    questionData.options.forEach(option => {
                        questionHtml += `<button class="option-button" data-value="${option}">${option}</button>`;
                    });
                    questionHtml += `</div>`;
                } else if (questionData.type === 'multiple-select') {
                    questionHtml += `<div id="options-container" class="space-y-4">`;
                    questionData.options.forEach(option => {
                        questionHtml += `
                            <label class="multiple-select-option">
                                <input type="checkbox" name="multiple-choice-option" value="${option.value}">
                                <span>${option.text}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                } else if (questionData.type === 'true-false') {
                    questionHtml += `<div id="options-container" class="space-y-4">`;
                    questionHtml += `<button class="option-button" data-value="true">Verdadero</button>`;
                    questionHtml += `<button class="option-button" data-value="false">Falso</button>`;
                    questionHtml += `</div>`;
                } else if (questionData.type === 'multi-direct-answer') {
                    questionHtml += `<div id="options-container" class="multi-part-question-container">`;
                    questionData.parts.forEach((part, index) => {
                        questionHtml += `
                            <div class="multi-part-question-item">
                                <label for="answer-input-${index}">${part.prompt}</label>
                                <input type="text" id="answer-input-${index}" class="direct-answer-input" placeholder="Escribe tu respuesta aquí...">
                            </div>
                        `;
                    });
                    questionHtml += `</div>`;
                }

                questionHtml += `
                    <div class="flex justify-between mt-8">
                        <button id="prevBtn" class="main-button"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <button id="nextBtn" class="main-button" disabled>Siguiente <i class="fas fa-arrow-right"></i></button>
                    </div>
                `;
                
                quizApp.innerHTML = questionHtml;
                updateButtonsState();

                if (userAnswers[currentQuestionIndex] !== null) {
                    const savedAnswer = userAnswers[currentQuestionIndex];
                    if (questionData.type === 'single-choice' || questionData.type === 'true-false') {
                        const buttons = quizApp.querySelectorAll('.option-button');
                        buttons.forEach(button => {
                            if (button.dataset.value === savedAnswer) {
                                button.classList.add('selected');
                            }
                        });
                    } else if (questionData.type === 'multiple-select') {
                        const checkboxes = quizApp.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            if (savedAnswer && savedAnswer.includes(checkbox.value)) {
                                checkbox.checked = true;
                                checkbox.closest('label').classList.add('selected');
                            }
                        });
                    } else if (questionData.type === 'multi-direct-answer') {
                        savedAnswer.forEach((answer, index) => {
                            const input = quizApp.querySelector(`#answer-input-${index}`);
                            if (input) {
                                input.value = answer;
                            }
                        });
                    }
                }

                const optionsContainer = document.getElementById('options-container');
                if (questionData.type === 'single-choice' || questionData.type === 'true-false') {
                    optionsContainer.addEventListener('click', (e) => {
                        if (e.target.classList.contains('option-button')) {
                            const buttons = optionsContainer.querySelectorAll('.option-button');
                            buttons.forEach(btn => btn.classList.remove('selected'));
                            e.target.classList.add('selected');
                            userAnswers[currentQuestionIndex] = e.target.dataset.value;
                            updateButtonsState();
                        }
                    });
                } else if (questionData.type === 'multiple-select') {
                    optionsContainer.addEventListener('change', (e) => {
                        if (e.target.type === 'checkbox') {
                            const label = e.target.closest('label');
                            if (e.target.checked) {
                                label.classList.add('selected');
                            } else {
                                label.classList.remove('selected');
                            }
                            const selectedValues = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                            userAnswers[currentQuestionIndex] = selectedValues;
                            updateButtonsState();
                        }
                    });
                } else if (questionData.type === 'multi-direct-answer') {
                    optionsContainer.addEventListener('input', () => {
                        const inputs = optionsContainer.querySelectorAll('input[type="text"]');
                        const answers = Array.from(inputs).map(input => input.value);
                        userAnswers[currentQuestionIndex] = answers;
                        updateButtonsState();
                    });
                }
            }

            function updateButtonsState() {
                const nextBtn = document.getElementById('nextBtn');
                const prevBtn = document.getElementById('prevBtn');
                const currentAnswer = userAnswers[currentQuestionIndex];
                
                let isAnswered = false;
                const questionData = allQuestions[currentQuestionIndex];
                if (questionData.type === 'multiple-select' || questionData.type === 'multi-direct-answer') {
                    isAnswered = Array.isArray(currentAnswer) && currentAnswer.length > 0 && currentAnswer.some(ans => ans && ans.trim() !== '');
                } else {
                    isAnswered = currentAnswer !== null && currentAnswer !== '';
                }

                nextBtn.disabled = !isAnswered;
                if (currentQuestionIndex === allQuestions.length - 1) {
                    nextBtn.innerHTML = 'Finalizar <i class="fas fa-check-circle"></i>';
                    nextBtn.classList.remove('main-button');
                    nextBtn.classList.add('send-button');
                } else {
                    nextBtn.innerHTML = 'Siguiente <i class="fas fa-arrow-right"></i>';
                    nextBtn.classList.remove('send-button');
                    nextBtn.classList.add('main-button');
                }

                if (currentQuestionIndex === 0) {
                    prevBtn.disabled = true;
                    prevBtn.classList.add('opacity-50');
                } else {
                    prevBtn.disabled = false;
                    prevBtn.classList.remove('opacity-50');
                }

                nextBtn.onclick = handleNext;
                prevBtn.onclick = handlePrev;
            }

            function handleNext() {
                if (currentQuestionIndex < allQuestions.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion();
                } else {
                    finishQuiz();
                }
            }

            function handlePrev() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    renderQuestion();
                }
            }

            function finishQuiz() {
                if (!isQuizActive) return;
                isQuizActive = false;
                clearInterval(timerInterval);
                quizAppContainer.style.display = 'none';
                
                const endTime = new Date();
                const totalTimeInSeconds = Math.round((endTime - startTime) / 1000);
                const elapsedTimeFormatted = formatElapsedTime(totalTimeInSeconds);
                
                const dataToSend = {
                    type: 'quiz_results',
                    fullName: quizUserDetails.fullName,
                    email: quizUserDetails.email,
                    responseTime: elapsedTimeFormatted,
                    userAnswers: userAnswers 
                };

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Resultados del quiz enviados a Apps Script y evaluados:', data);
                })
                .catch(error => {
                    console.error('Error al enviar los resultados a Apps Script:', error);
                    alert('Ocurrió un error al enviar los resultados del quiz. Por favor, revisa la consola del navegador.');
                });

                const thanksDiv = document.createElement('div');
                thanksDiv.id = 'final-thanks-message';
                thanksDiv.innerHTML = `
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">¡Gracias por completar la prueba!</h2>
                        <p class="text-lg text-gray-600">Hemos enviado tus respuestas para su evaluación. Los resultados se enviarán a tu correo electrónico.</p>
                        <div class="mt-8">
                            <button id="backToHomeBtn" class="main-button">Volver al Inicio</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(thanksDiv);
                setTimeout(() => {
                    thanksDiv.classList.add('show');
                    document.getElementById('backToHomeBtn').addEventListener('click', () => {
                        window.location.reload();
                    });
                }, 100);
            }

            function startTimer() {
                const timerDisplay = document.getElementById('quizTimer');
                let seconds = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor((QUIZ_DURATION_SECONDS - seconds) / 60);
                    const remainingSeconds = (QUIZ_DURATION_SECONDS - seconds) % 60;
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    timerDisplay.textContent = formattedTime;

                    if (QUIZ_DURATION_SECONDS - seconds <= 60) {
                        timerDisplay.classList.add('low-time');
                    }
                    if (seconds >= QUIZ_DURATION_SECONDS) {
                        finishQuiz();
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }

            function formatElapsedTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        });
    </script>
</body>
</html>
