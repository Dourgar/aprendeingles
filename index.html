<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendiendo Ingl√©s con Douglas</title>
    <link rel="icon" href="birrete.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .prose a {
            color: #2b6cb0;
            text-decoration: underline;
        }
        .prose a:hover {
            color: #1e4b85;
        }
        /* Estilos del Quiz */
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .option-button.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .multiple-select-option:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .multiple-select-option.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.5);
            accent-color: #6366f1;
        }
        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca);
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81);
            transform: translateY(-4px);
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
            background-image: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message, #registration-success-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800;
            color: #4338ca;
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show, #registration-success-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto;
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626;
            background-color: #fee2e2;
        }
        .multi-part-question-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .multi-part-question-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .multi-part-question-item label {
            font-weight: 600;
            color: #4a5568;
        }
        .module-selection-card {
            background-color: #f0f4f8;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .module-selection-card select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 0.75rem;
            border: 2px solid #e0e7ee;
            background-color: #ffffff;
            color: #3f4a5a;
        }
        .module-selection-card select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .attempts-counter {
            font-weight: 600;
            margin-top: 1rem;
        }
        .disabled-module-link {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        @media (max-width: 768px) {
            .option-button, .multiple-select-option {
                font-size: 1rem;
                padding: 0.8rem 1rem;
            }
            .main-button, .send-button {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
            }
            #introSection h1 {
                font-size: 2.5rem;
            }
            #introSection p {
                font-size: 1.1rem;
            }
            .prose h4 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <nav id="mainNav" class="bg-gradient-to-r from-blue-600 to-blue-800 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-white text-3xl font-bold tracking-wide">Aprendiendo Ingl√©s con Douglas</a>
            <div id="navButtons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="navLoginBtn" class="bg-white text-blue-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-200 transition duration-300 shadow-md">Iniciar Sesi√≥n</button>
                <button id="navRegisterBtn" class="bg-green-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-green-600 transition duration-300 shadow-md">Inscribirse</button>
            </div>
        </div>
    </nav>

    <div id="mainContent">

        <section id="introSection" class="relative bg-gradient-to-br from-blue-500 to-indigo-600 text-white py-12 md:py-20 px-4 text-center shadow-inner min-h-screen flex items-center">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="relative z-10 container mx-auto">
                <h1 class="text-4xl md:text-6xl font-extrabold leading-tight mb-6 animate-fade-in-down">¬°Desbloquea tu Potencial en Ingl√©s!</h1>
                <p class="text-xl md:text-2xl mb-10 max-w-3xl mx-auto opacity-90 animate-fade-in-up">Sum√©rgete en un viaje fascinante para dominar el ingl√©s de forma pr√°ctica y divertida. ¬°Tu aventura comienza aqu√≠!</p>
                <button id="startLearningBtn" class="bg-yellow-400 text-blue-900 py-4 px-10 rounded-full text-xl font-bold uppercase hover:bg-yellow-500 transition duration-300 transform hover:scale-105 shadow-lg">Comienza a Aprender Hoy</button>
            </div>
        </section>

        <section id="quizInstructionsSection" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Instrucciones de la Prueba</h2>
                <div class="prose max-w-none text-gray-700">
                    <p class="text-lg">¬°Bienvenido al quiz de ingl√©s! A continuaci√≥n, se detallan las reglas para completar la prueba:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li>La prueba tiene una duraci√≥n m√°xima de **20 minutos**.</li>
                        <li>Una vez iniciada la prueba, el tiempo no se detiene.</li>
                        <li>Debes responder todas las preguntas para poder avanzar.</li>
                        <li>En las preguntas de selecci√≥n m√∫ltiple, se te dar√° una puntuaci√≥n parcial por cada respuesta correcta.</li>
                        <li>Solo tienes un m√°ximo de **2 intentos** para presentar la prueba.</li>
                        <li>Los resultados te ser√°n enviados por correo electr√≥nico, al igual que un mensaje al administrador.</li>
                    </ul>
                    <p class="text-lg font-bold mt-4">¬°Mucho √©xito!</p>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="openQuizStartModalBtn" class="main-button">Comenzar</button>
                </div>
            </div>
        </section>

        <div id="quiz-app-container" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div id="quiz-app" class="bg-white p-8 rounded-lg shadow-lg"></div>
        </div>

        <section id="virtualClassroomSection" class="container mx-auto mt-8 p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row gap-8">
                    <aside class="md:w-1/4">
                        <h3 class="text-2xl font-bold text-blue-700 mb-4">Temas</h3>
                        <ul id="topic-list" class="space-y-2">
                            </ul>
                    </aside>
                    <main class="md:w-3/4" id="topic-content">
                        <h2 class="text-3xl font-bold text-gray-700 mb-4">Bienvenido al Aula Virtual</h2>
                        <p class="text-lg text-gray-600">Selecciona un tema del men√∫ de la izquierda para comenzar a aprender.</p>
                    </main>
                </div>
            </div>
        </section>

    </div>

    <div id="quizStartModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeQuizStartModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Comenzar la Prueba</h2>
            <form id="quizStartForm" class="space-y-5">
                <div>
                    <label for="quizNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="quizNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="quizEmail" class="block text-gray-700 text-lg font-medium mb-2">Correo Electr√≥nico:</label>
                    <input type="email" id="quizEmail" name="email" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="quizStartBtnText">Iniciar Prueba</span>
                    <span id="quizStartSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <p id="quizAttemptsMessage" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>
    
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeLoginModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Iniciar Sesi√≥n</h2>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label for="loginEmail" class="block text-gray-700 text-lg font-medium mb-2">Correo Electr√≥nico:</label>
                    <input type="email" id="loginEmail" name="email" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-gray-700 text-lg font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="loginPassword" name="password" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="loginBtnText">Entrar</span>
                    <span id="loginSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <div id="loginMessage" class="text-center text-red-500 mt-4 font-medium" style="display:none;"></div>
                <button type="button" id="forgotPasswordBtn" class="w-full text-sm text-blue-500 hover:underline mt-4">¬øOlvidaste tu contrase√±a?</button>
            </form>
        </div>
    </div>

    <div id="registerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-2/3 lg:w-1/2 relative transform scale-95 transition-transform duration-300 ease-out">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" id="closeRegisterModal">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-blue-700">Formulario de Inscripci√≥n Formal</h2>
            <form id="registrationForm" class="space-y-5">
                <div>
                    <label for="regNombre" class="block text-gray-700 text-lg font-medium mb-2">Nombre Completo:</label>
                    <input type="text" id="regNombre" name="nombre" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="regCedula" class="block text-gray-700 text-lg font-medium mb-2">C√©dula de Identidad:</label>
                    <input type="text" id="regCedula" name="cedula" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <div>
                    <label for="regEdad" class="block text-gray-700 text-lg font-medium mb-2">Edad:</label>
                    <input type="number" id="regEdad" name="edad" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required min="10" max="100">
                </div>
                <div>
                    <label for="regEmail" class="block text-gray-700 text-lg font-medium mb-2">Correo Electr√≥nico:</label>
                    <input type="email" id="regEmail" name="correo" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                </div>
                <button type="submit" class="w-full main-button mt-6">
                    <span id="registrationBtnText">Inscribirme</span>
                    <span id="registrationSpinner" class="loading-spinner" style="display:none;"></span>
                </button>
                <div id="registerMessage" class="text-center text-red-500 mt-4 font-medium" style="display:none;"></div>
            </form>
        </div>
    </div>

    <div id="registration-success-message" class="hidden">
        <p class="text-2xl md:text-3xl font-bold text-gray-700 mb-6">¬°Inscripci√≥n Exitosa! üéâ</p>
        <p class="text-base md:text-lg font-medium text-gray-500 mb-8">
            Su inscripci√≥n ha sido recibida con √©xito. Pronto se enviar√° a su correo las credenciales para entrar al Aula Virtual.
        </p>
        <button id="backToHomeBtn" class="send-button mt-6">Regresar a Inicio</button>
    </div>

    <div id="final-thanks-message" class="hidden">
        ¬°Gracias por completar el quiz!<br><br>
        Tus resultados ser√°n enviados a tu correo electr√≥nico.<br><br>
        <button id="backToHomeFromQuizBtn" class="send-button mt-6">Volver a Inicio</button>
    </div>

    <footer class="bg-gray-800 text-gray-300 py-8 mt-12">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 Aprendiendo Ingl√©s con Douglas. Todos los derechos reservados.</p>
            <p class="mt-2">Contacto: <a href="mailto:douglas@example.com" class="text-blue-400 hover:underline">douglas@example.com</a></p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="#" class="text-blue-400 hover:text-white transition duration-300"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-blue-400 hover:text-white transition duration-300"><i class="fas fa-x"></i></a>
                <a href="#" class="text-blue-400 hover:text-white transition duration-300"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        
            const firebaseConfig = {
                apiKey: "AIzaSyDjl1A1gyVxtmxBy5t3boD5Zg39cz3OruQ",
                authDomain: "aprendiendo-ingles-con-douglas.firebaseapp.com",
                projectId: "aprendiendo-ingles-con-douglas",
                storageBucket: "aprendiendo-ingles-con-douglas.firebasestorage.app",
                messagingSenderId: "731161369311",
                appId: "1:731161369311:web:c15c6cde4883967f60a76a"
            };
        
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
        
            const EMAILJS_SERVICE_ID = 'service_28cktz7';
            const EMAILJS_TEMPLATE_ID_BIENVENIDA = 'template_m4dix9e';
            const EMAILJS_TEMPLATE_ID_RESULTADOS = 'template_vmbbdxe';
            const EMAILJS_PUBLIC_KEY = '45vytS3SV1Zbuiy_7';
            
            emailjs.init(EMAILJS_PUBLIC_KEY);
        
            const QUIZ_DURATION_SECONDS = 20 * 60;
            let timerInterval;
            let elapsedSeconds = 0;
            let quizStartTime;
            let currentQuestionIndex = 0;
            let userAnswers = [];
            let currentQuizSource = "main-quiz";
        
            // =======================================================
            // INICIO: Base de datos de Temas y Evaluaciones del Aula Virtual
            // =======================================================
            const classroomData = {
                "tema1": {
                    title: "Present Tense of 'To Be' / El presente del verbo 'To Be'",
                    explanation: "El verbo 'to be' en presente se utiliza para hablar de estados, ocupaciones, descripciones y ubicaciones. Es uno de los verbos m√°s importantes en ingl√©s y se conjuga de tres formas: **am** (para 'I'), **is** (para 'he', 'she', 'it') y **are** (para 'you', 'we', 'they').  A diferencia del espa√±ol, en ingl√©s se usa el verbo 'to be' para expresar la edad, como en 'I am 20 years old'.\n\n**Contracciones:** Para un ingl√©s m√°s fluido e informal, se usan las contracciones. Consisten en unir el pronombre con el verbo 'to be' y reemplazar la vocal con un ap√≥strofo. Por ejemplo: \n* I am -> **I'm**\n* You are -> **You're**\n* He is -> **He's**\n* She is -> **She's**\n* It is -> **It's**\n* We are -> **We're**\n* They are -> **They're**",
                    examples: [
                        "I **am** a student. / Yo soy un estudiante.",
                        "She **is** from Venezuela. / Ella es de Venezuela.",
                        "They **are** happy. / Ellos est√°n felices.",
                        "**Is** he a teacher? Yes, he **is**. / ¬øEs √©l un profesor? S√≠, lo es.",
                        "We **are not** sad. We **are** excited. / Nosotros no estamos tristes. Estamos emocionados.",
                        "The dog **is** in the garden. / El perro est√° en el jard√≠n."
                    ],
                    resources: [
                        { type: "document", title: "Ejercicios y gram√°tica", url: "https://www.ejemplos.com/documento-to-be.pdf" },
                        { type: "video", title: "Video explicativo: 'To Be'", url: "https://www.youtube.com/embed/dQw4w9WgXcQ" },
                        { type: "audio", title: "Audio de pronunciaci√≥n", url: "https://www.ejemplos.com/audio-to-be.mp3" }
                    ],
                    quiz: [
                        {
                            question: "Completa la oraci√≥n: 'She _______ my sister.'",
                            options: ["a) am", "b) are", "c) is"],
                            quizType: "single-choice",
                            correctAnswers: ["c"]
                        },
                        {
                            question: "La contracci√≥n de 'You are' es 'You're'.",
                            options: ["true", "false"],
                            quizType: "true-false",
                            correctAnswers: ["true"]
                        }
                    ]
                },
                "tema2": {
                    title: "The Simple Present Tense / El Presente Simple",
                    explanation: "El presente simple se utiliza para hablar de acciones habituales, verdades generales, hechos cient√≠ficos, y eventos programados. Es un tiempo verbal fundamental. Para la tercera persona del singular (he, she, it), se a√±ade una **'s'** al final del verbo (ejemplo: 'she plays'). En su forma negativa e interrogativa, se usan los auxiliares 'do' y 'does'.",
                    examples: [
                        "I **play** soccer every Sunday. / Yo juego f√∫tbol cada domingo.",
                        "She **works** in a bank. / Ella trabaja en un banco.",
                        "The sun **rises** in the east. / El sol sale por el este.",
                        "We **don't** live in New York. / Nosotros no vivimos en Nueva York.",
                        "**Does** he speak French? No, he **doesn't**. / ¬ø√âl habla franc√©s? No, no lo hace.",
                        "They **go** to the cinema once a month. / Ellos van al cine una vez al mes."
                    ],
                    resources: [
                        { type: "document", title: "Ejercicios y verbos comunes", url: "https://www.ejemplos.com/documento-present-simple.pdf" },
                        { type: "video", title: "Video explicativo: Presente Simple", url: "https://www.youtube.com/embed/tgbNymZ7vqY" },
                        { type: "audio", title: "Audio de verbos en Simple Present", url: "https://www.ejemplos.com/audio-present-simple.mp3" }
                    ],
                    quiz: [
                        {
                            question: "Completa la oraci√≥n: 'He _______ to school every day.'",
                            options: ["a) go", "b) goes", "c) going"],
                            quizType: "single-choice",
                            correctAnswers: ["b"]
                        },
                        {
                            question: "La oraci√≥n 'They speaks Spanish' es gramaticalmente correcta.",
                            options: ["true", "false"],
                            quizType: "true-false",
                            correctAnswers: ["false"]
                        }
                    ]
                }
                // COMENTARIO: Para a√±adir un nuevo tema, copia la estructura de un tema existente y p√©gala aqu√≠.
                // Aseg√∫rate de usar una clave √∫nica como "tema3".
                // Por ejemplo:
                // "tema3": {
                //     title: "Nuevo Tema",
                //     explanation: "...",
                //     examples: ["..."],
                //     resources: [{ type: "document", title: "...", url: "..." }, ...],
                //     quiz: [{ question: "...", options: ["..."], ... }, ...]
                // }
            };
            // =MENTARIO: Para a√±adir un nuevo tema, copia la estructura de un tema existente y p√©gala aqu√≠.
            // Aseg√∫rate de usar una clave √∫nica como "tema3".
            // Por ejemplo:
            // "tema3": {
            //     title: "Nuevo Tema",
            //     explanation: "...",
            //     examples: ["..."],
            //     resources: [{ type: "document", title: "...", url: "..." }, ...],
            //     quiz: [{ question: "...", options: ["..."], ... }, ...]
            // }
            // =======================================================
            // FIN: Base de datos de Temas y Evaluaciones del Aula Virtual
            // =======================================================


            // =======================================================
            // INICIO: Base de datos del Quiz de Nivelaci√≥n
            // =======================================================
            const quizData = [
                {
                    question: "Presentaci√≥n y saludos (formal/informal)<br>Which of the following are informal greetings? (Select all that apply) / ¬øCu√°les de las siguientes son saludos informales? (Selecciona todas las que apliquen):",
                    options: ["a) Good morning", "b) How do you do?", "c) What‚Äôs up?", "d) Nice to meet you", "e) Hey!", "f) Goodbye", "g) What's new?"],
                    quizType: "multiple-select",
                    correctAnswers: ["c", "e", "g"]
                },
                {
                    question: "Verbo ‚ÄúTo be‚Äù (presente)<br>Completa la oraci√≥n: 'He _______ a doctor.' con la forma correcta del verbo 'to be'",
                    options: ["a) am", "b) are", "c) is", "d) be"],
                    quizType: "single-choice",
                    correctAnswers: ["c"]
                },
                {
                    question: "Adjetivos Posesivos<br>Completa la oraci√≥n: 'This is ___ car. (He)' con el adjetivo posesivo correcto.",
                    quizType: "multi-direct-answer",
                    correctAnswers: ["his"]
                },
                {
                    question: "D√≠as de la semana<br>La traducci√≥n correcta de 'Lunes' es 'Monday'.",
                    options: ["true", "false"],
                    quizType: "true-false",
                    correctAnswers: ["true"]
                },
                {
                    question: "Despedidas<br>Select the appropriate ways to say goodbye. / Selecciona las formas en que podemos despedirnos (Escoge todas las que apliquen):",
                    options: ["a) See you later!", "b) Bye!", "c) Have a good day", "d) How are you?", "e) Good night", "f) See you tomorrow", "g) Hi"],
                    quizType: "multiple-select",
                    correctAnswers: ["a", "b", "c", "e", "f"]
                },
                {
                    question: "D√≠as de la semana<br>Select the correct order. / Selecciona el orden correcto:",
                    options: ["a) Monday, Sunday, Tuesday", "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday", "c) Sunday, Tuesday, Monday"],
                    quizType: "single-choice",
                    correctAnswers: ["b"]
                },
                {
                    question: "Art√≠culos A - AN<br>Completa la oraci√≥n: 'It's ___ apple.' con el art√≠culo correcto.",
                    quizType: "multi-direct-answer",
                    correctAnswers: ["an"]
                },
                {
                    question: "Pronombres Personales<br>'Nosotros' se traduce como 'We'.",
                    options: ["true", "false"],
                    quizType: "true-false",
                    correctAnswers: ["true"]
                },
                {
                    question: "Meses del a√±o<br>Which of these are months of the year? (Select all that apply) / ¬øCu√°les de estos son meses del a√±o? (Selecciona todas las que apliquen):",
                    options: ["a) January", "b) Winter", "c) Spring", "d) July", "e) December", "f) Monday", "g) November"],
                    quizType: "multiple-select",
                    correctAnswers: ["a", "d", "e", "g"]
                },
                {
                    question: "N√∫meros cardinales y ordinales<br>Choose the correct ordinal numbers. / Escoge los n√∫meros ordinales:",
                    options: ["a) First", "b) Three", "c) Third", "d) Seven", "e) Fifth", "f) Second", "g) Six"],
                    quizType: "multiple-select",
                    correctAnswers: ["a", "c", "e", "f"]
                },
                {
                    question: "Verbo ‚ÄúTo be‚Äù (presente)<br>La traducci√≥n de la oraci√≥n 'Ellos son mis amigos' es 'They are my friends'.",
                    options: ["true", "false"],
                    quizType: "true-false",
                    correctAnswers: ["true"]
                },
                {
                    question: "N√∫meros Cardinales<br>Traduce los siguientes n√∫meros: 1, 2, 3, 4, 5.",
                    quizType: "multi-direct-answer",
                    correctAnswers: ["one", "two", "three", "four", "five"]
                },
                {
                    question: "Art√≠culos A - AN<br>'An' se usa antes de una palabra que comienza con una vocal.",
                    options: ["true", "false"],
                    quizType: "true-false",
                    correctAnswers: ["true"]
                },
                {
                    question: "Preguntas con ‚ÄúTo be‚Äù<br>Reorganiza las palabras para formar una pregunta correcta: a good student / you / are",
                    quizType: "multi-direct-answer",
                    correctAnswers: ["are you a good student"]
                }
            ];
            // =======================================================
            // FIN: Base de datos del Quiz de Nivelaci√≥n
            // =======================================================
            
            let currentQuizData = quizData;
            let currentQuizTitle = "Nivelaci√≥n";
            
            let currentUserEmail = '';
            let currentUserFullName = '';
            
            let currentTopicKey = ''; // Variable para rastrear el tema actual en el aula virtual
        
            // Manejo de la autenticaci√≥n
            auth.onAuthStateChanged(user => {
                const navButtons = document.getElementById('navButtons');
                if (user) {
                    // Usuario logueado
                    navButtons.innerHTML = `
                        <span class="text-white text-lg font-semibold mr-4 hidden md:inline">¬°Hola, ${user.email}!</span>
                        <button id="navLogoutBtn" class="bg-red-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-red-600 transition duration-300 shadow-md">Cerrar Sesi√≥n</button>
                    `;
                    document.getElementById('navLogoutBtn').addEventListener('click', () => {
                        auth.signOut();
                        window.location.reload();
                    });
                    
                    // Mostrar el aula virtual en lugar de la intro
                    showSection('virtualClassroomSection');
                    renderVirtualClassroom();

                } else {
                    // Usuario no logueado
                    navButtons.innerHTML = `
                        <button id="navLoginBtn" class="bg-white text-blue-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-200 transition duration-300 shadow-md">Iniciar Sesi√≥n</button>
                        <button id="navRegisterBtn" class="bg-green-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-green-600 transition duration-300 shadow-md">Inscribirse</button>
                    `;
                    document.getElementById('navLoginBtn').addEventListener('click', () => showModal('loginModal'));
                    document.getElementById('navRegisterBtn').addEventListener('click', () => showModal('registerModal'));
                    showSection('introSection');
                }
            });

            // =======================================================
            // INICIO: Funciones de renderizado del Aula Virtual
            // =======================================================
            function renderVirtualClassroom() {
                const topicList = document.getElementById('topic-list');
                topicList.innerHTML = '';
                Object.keys(classroomData).forEach(key => {
                    const topic = classroomData[key];
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="#" class="block px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors duration-200" data-topic-key="${key}">${topic.title}</a>
                    `;
                    topicList.appendChild(li);
                });

                document.querySelectorAll('#topic-list a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const topicKey = e.target.dataset.topic-key;
                        currentTopicKey = topicKey;
                        renderTopicContent(topicKey);
                    });
                });
            }

            function renderTopicContent(topicKey) {
                const topicContent = document.getElementById('topic-content');
                const topic = classroomData[topicKey];

                const resourceHtml = topic.resources.map(res => {
                    if (res.type === 'document') {
                        return `
                            <div class="flex items-center space-x-3 p-4 bg-gray-100 rounded-lg shadow-sm">
                                <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                                <a href="${res.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${res.title}</a>
                            </div>
                        `;
                    } else if (res.type === 'video') {
                        return `
                            <div class="aspect-w-16 aspect-h-9 my-4 overflow-hidden rounded-lg shadow-md">
                                <iframe src="${res.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-64 md:h-96"></iframe>
                            </div>
                        `;
                    } else if (res.type === 'audio') {
                        return `
                            <div class="my-4 p-4 bg-gray-100 rounded-lg shadow-sm">
                                <p class="font-medium text-gray-700 mb-2">${res.title}</p>
                                <audio controls class="w-full"><source src="${res.url}" type="audio/mpeg"></audio>
                            </div>
                        `;
                    }
                }).join('');

                topicContent.innerHTML = `
                    <h2 class="text-3xl font-bold text-blue-700 mb-4">${topic.title}</h2>
                    <div class="prose max-w-none text-gray-700 mb-6">
                        <h4 class="font-bold text-xl">Explicaci√≥n</h4>
                        <p>${topic.explanation.replace(/\n/g, '<br><br>')}</p>
                        <h4 class="font-bold text-xl mt-4">Ejemplos</h4>
                        <ul class="list-disc list-inside">
                            ${topic.examples.map(ex => `<li>${ex}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <h4 class="font-bold text-xl text-blue-700 mt-8 mb-4">Recursos Adicionales</h4>
                    <div class="space-y-4">
                        ${resourceHtml}
                    </div>

                    <h4 class="font-bold text-xl text-blue-700 mt-8 mb-4">Evaluaci√≥n</h4>
                    <button id="startTopicQuizBtn" class="main-button">Comenzar Evaluaci√≥n de ${topic.title}</button>
                    
                    <div id="topic-quiz-container" class="mt-6 hidden">
                        <div id="topic-quiz-app" class="bg-white p-8 rounded-lg shadow-lg"></div>
                    </div>
                `;
                
                document.getElementById('startTopicQuizBtn').addEventListener('click', () => {
                    document.getElementById('topic-quiz-container').classList.remove('hidden');
                    startTopicQuiz(topic.quiz, topic.title);
                });
            }
            
            function startTopicQuiz(quizQuestions, quizTitle) {
                currentQuizData = quizQuestions;
                currentQuizTitle = quizTitle;
                userAnswers = Array(currentQuizData.length).fill(null);
                currentQuestionIndex = 0;
                currentQuizSource = "topic-quiz";
                
                // Ocultar el bot√≥n de iniciar quiz
                document.getElementById('startTopicQuizBtn').style.display = 'none';

                // Renderizar el quiz
                const quizApp = document.getElementById('topic-quiz-app');
                quizApp.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-blue-700">Evaluaci√≥n de ${quizTitle}</h2>
                    </div>
                    <div class="progress-bar-container">
                        <div id="quizProgressBar" class="progress-bar"></div>
                    </div>
                    <div id="quizQuestionCounter" class="text-center text-gray-500 mb-6"></div>
                    <div id="quizQuestionsContainer" class="space-y-6 mt-6"></div>
                    <div class="flex justify-between mt-8">
                        <button id="prevQuestionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">Atr√°s</button>
                        <button id="nextQuestionBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">Siguiente</button>
                    </div>
                `;
                showQuestion(currentQuestionIndex);
                document.getElementById('nextQuestionBtn').addEventListener('click', handleNext);
                document.getElementById('prevQuestionBtn').addEventListener('click', handlePrev);
            }
            // =======================================================
            // FIN: Funciones de renderizado del Aula Virtual
            // =======================================================
        
            function showSection(sectionId) {
                document.querySelectorAll('section, div[id$="Modal"], div[id$="container"], #final-thanks-message, #registration-success-message').forEach(el => {
                    if (!el.classList.contains('hidden')) {
                        el.classList.add('hidden');
                    }
                });
                document.getElementById(sectionId).classList.remove('hidden');
            }
        
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                }, 10);
            }
        
            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            
            function setButtonLoadingState(buttonTextId, isLoading) {
                const button = document.getElementById(buttonTextId).parentElement;
                const textSpan = document.getElementById(buttonTextId);
                const spinnerSpan = button.querySelector('.loading-spinner');
                button.disabled = isLoading;
                if (textSpan) {
                    textSpan.style.display = isLoading ? 'none' : 'inline';
                }
                if (spinnerSpan) {
                    spinnerSpan.style.display = isLoading ? 'inline-block' : 'none';
                }
            }
        
            function showQuestion(index) {
                const questionsContainer = document.getElementById('quizQuestionsContainer');
                questionsContainer.innerHTML = '';
                const questionCounter = document.getElementById('quizQuestionCounter');
                
                const quizDataToUse = currentQuizSource === "main-quiz" ? quizData : currentQuizData;
                const question = quizDataToUse[index];
                const questionElement = document.createElement('div');
                questionElement.classList.add('quiz-question', 'p-6', 'bg-gray-50', 'rounded-lg', 'shadow-sm');
                let optionsHtml = '';
        
                if (question.quizType === 'multi-direct-answer') {
                    const numInputs = question.question.includes('1, 2, 3, 4, 5') ? 5 : 1;
                    let inputsHtml = '';
                    if (numInputs > 1) {
                        inputsHtml = `<div class="multi-part-question-container">`;
                        for (let i = 0; i < numInputs; i++) {
                            inputsHtml += `<input type="text" name="q${index}_${i}" class="direct-answer-input" placeholder="Respuesta ${i + 1}" value="${userAnswers[index]?.[i] || ''}">`;
                        }
                        inputsHtml += `</div>`;
                    } else {
                        inputsHtml = `<input type="text" name="q${index}_0" class="direct-answer-input" placeholder="Escribe tu respuesta aqu√≠..." value="${userAnswers[index]?.[0] || ''}">`;
                    }
                    optionsHtml = inputsHtml;
                } else if (question.quizType === 'multiple-select') {
                    optionsHtml = question.options.map((option, i) => `
                        <label class="multiple-select-option ${userAnswers[index]?.includes(String.fromCharCode(97 + i)) ? 'selected' : ''}">
                            <input type="checkbox" name="q${index}" value="${String.fromCharCode(97 + i)}" class="mr-3 transform scale-125" ${userAnswers[index]?.includes(String.fromCharCode(97 + i)) ? 'checked' : ''}>
                            <span class="ml-2">${option}</span>
                        </label>
                    `).join('');
                } else { // single-choice and true-false
                    optionsHtml = question.options.map((option, i) => {
                        const value = option.split(')')[0].toLowerCase().trim();
                        const isSelected = userAnswers[index]?.[0] === value;
                        return `
                            <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-question-index="${index}" data-value="${value}">
                                ${option}
                            </button>
                        `;
                    }).join('');
                }
        
                questionElement.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-blue-600">√çtem ${index + 1}</p>
                    <p class="text-base leading-relaxed mb-4">${question.question}</p>
                    <div class="space-y-3 mt-2">${optionsHtml}</div>
                `;
                questionsContainer.appendChild(questionElement);
        
                addQuestionListeners(index);
        
                questionCounter.textContent = `√çtem ${index + 1} de ${quizDataToUse.length}`;
                updateNavigationButtons(quizDataToUse.length);
                checkQuestionAnswered(index);
            }
        
            function addQuestionListeners(index) {
                const question = currentQuizData[index];
                if (question.quizType === 'multi-direct-answer') {
                    const inputs = document.querySelectorAll('.direct-answer-input');
                    inputs.forEach(input => input.addEventListener('input', () => checkQuestionAnswered(index)));
                } else if (question.quizType === 'multiple-select') {
                    const labels = document.querySelectorAll('.multiple-select-option');
                    labels.forEach(label => label.addEventListener('click', () => {
                        const checkbox = label.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        label.classList.toggle('selected', checkbox.checked);
                        checkQuestionAnswered(index);
                    }));
                } else {
                    const buttons = document.querySelectorAll('.option-button');
                    buttons.forEach(button => button.addEventListener('click', () => {
                        const questionButtons = document.querySelectorAll(`.option-button[data-question-index="${index}"]`);
                        questionButtons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        checkQuestionAnswered(index);
                    }));
                }
            }
        
            function checkQuestionAnswered(index) {
                const nextButton = document.getElementById('nextQuestionBtn');
                const question = currentQuizData[index];
                let isAnswered = false;
                
                if (question.quizType === 'multi-direct-answer') {
                    const inputs = document.querySelectorAll('.direct-answer-input');
                    isAnswered = Array.from(inputs).some(input => input.value.trim() !== '');
                } else if (question.quizType === 'multiple-select') {
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                    isAnswered = checkboxes.length > 0;
                } else {
                    const selectedButton = document.querySelector('.option-button.selected');
                    isAnswered = selectedButton !== null;
                }
        
                nextButton.disabled = !isAnswered;
            }
        
            function saveCurrentAnswer() {
                const question = currentQuizData[currentQuestionIndex];
                if (question.quizType === 'multi-direct-answer') {
                    const inputs = document.querySelectorAll('.direct-answer-input');
                    userAnswers[currentQuestionIndex] = Array.from(inputs).map(input => input.value.toLowerCase().trim());
                } else if (question.quizType === 'multiple-select') {
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                    userAnswers[currentQuestionIndex] = Array.from(checkboxes).map(checkbox => checkbox.value);
                } else {
                    const selectedButton = document.querySelector('.option-button.selected');
                    userAnswers[currentQuestionIndex] = selectedButton ? [selectedButton.dataset.value] : null;
                }
            }
        
            function updateNavigationButtons(totalQuestions) {
                const prevBtn = document.getElementById('prevQuestionBtn');
                const nextBtn = document.getElementById('nextQuestionBtn');
                
                if (currentQuestionIndex === 0 && currentQuizSource === "topic-quiz") {
                    prevBtn.textContent = 'Volver a Temas';
                    prevBtn.classList.remove('bg-blue-500');
                    prevBtn.classList.add('bg-gray-500');
                } else if (currentQuestionIndex === 0) {
                    prevBtn.style.visibility = 'hidden';
                } else {
                    prevBtn.textContent = 'Atr√°s';
                    prevBtn.style.visibility = 'visible';
                    prevBtn.classList.remove('bg-gray-500');
                    prevBtn.classList.add('bg-blue-500');
                }
        
                if (currentQuestionIndex === totalQuestions - 1) {
                    nextBtn.textContent = 'Enviar Resultados';
                    nextBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                    nextBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                } else {
                    nextBtn.textContent = 'Siguiente';
                    nextBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                    nextBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }
            }
        
            function handleNext() {
                saveCurrentAnswer();
                if (currentQuestionIndex < currentQuizData.length - 1) {
                    currentQuestionIndex++;
                    showQuestion(currentQuestionIndex);
                } else {
                    finishQuiz();
                }
            }
        
            function handlePrev() {
                if (currentQuestionIndex === 0 && currentQuizSource === "topic-quiz") {
                    document.getElementById('topic-quiz-container').classList.add('hidden');
                    document.getElementById('startTopicQuizBtn').style.display = 'block';
                } else if (currentQuestionIndex > 0) {
                    saveCurrentAnswer();
                    currentQuestionIndex--;
                    showQuestion(currentQuestionIndex);
                }
            }
            
            function startLevelingQuiz() {
                currentQuizData = quizData;
                currentQuizTitle = "Nivelaci√≥n";
                userAnswers = Array(currentQuizData.length).fill(null);
                currentQuestionIndex = 0;
                currentQuizSource = "main-quiz";
                showSection('quiz-app-container');
                
                const quizApp = document.getElementById('quiz-app');
                quizApp.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-blue-700">Quiz de Nivelaci√≥n</h2>
                        <div id="quizTimer" class="timer-display">20:00</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="quizProgressBar" class="progress-bar"></div>
                    </div>
                    <div id="quizQuestionCounter" class="text-center text-gray-500 mb-6"></div>
                    <div id="quizQuestionsContainer" class="space-y-6 mt-6"></div>
                    <div class="flex justify-between mt-8">
                        <button id="prevQuestionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">Atr√°s</button>
                        <button id="nextQuestionBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">Siguiente</button>
                    </div>
                `;
                
                showQuestion(currentQuestionIndex);
                startTimer();
                quizStartTime = new Date();
                document.getElementById('nextQuestionBtn').addEventListener('click', handleNext);
                document.getElementById('prevQuestionBtn').addEventListener('click', handlePrev);
            }
            
            function startTimer() {
                const timerDisplay = document.getElementById('quizTimer');
                const progressBar = document.getElementById('quizProgressBar');
                timerInterval = setInterval(() => {
                    elapsedSeconds++;
                    const remainingTime = QUIZ_DURATION_SECONDS - elapsedSeconds;
        
                    if (remainingTime <= 0) {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = '00:00';
                        finishQuiz();
                        return;
                    }
        
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    timerDisplay.textContent = formattedTime;
        
                    if (remainingTime <= 60) {
                        timerDisplay.classList.add('low-time');
                    }
        
                    const progressPercentage = (elapsedSeconds / QUIZ_DURATION_SECONDS) * 100;
                    progressBar.style.width = `${progressPercentage}%`;
                }, 1000);
            }
        
            function gradeQuiz() {
                let score = 0;
                let feedback = "A continuaci√≥n, un resumen de tus respuestas:\n\n";
                
                currentQuizData.forEach((question, index) => {
                    const questionNumber = index + 1;
                    const userResponse = userAnswers[index];
                    const correctResponse = question.correctAnswers;
            
                    feedback += `--- √çtem ${questionNumber}: ${question.question.split('<br>')[0]} ---\n`;
                    feedback += `Tu respuesta: ${Array.isArray(userResponse) ? userResponse.join(', ') : userResponse}\n`;
                    feedback += `Respuesta(s) correcta(s): ${Array.isArray(correctResponse) ? correctResponse.join(', ') : correctResponse}\n`;
                    
                    let questionScore = 0;
            
                    if (question.quizType === 'multiple-select') {
                        if (userResponse) {
                            let correctSelections = userResponse.filter(answer => correctResponse.includes(answer)).length;
                            questionScore = (correctSelections / correctResponse.length) * 2;
                        }
                    } else if (question.question.includes('1, 2, 3, 4, 5')) {
                        let correctCount = 0;
                        if (userResponse) {
                            userResponse.forEach((answer, i) => {
                                if (answer === correctResponse[i]) {
                                    correctCount++;
                                }
                            });
                        }
                        questionScore = correctCount * 0.6;
                    } else if (question.quizType === 'multi-direct-answer') {
                        if (userResponse && userResponse[0] === correctResponse[0]) {
                            questionScore = 1;
                        }
                    } else { // single-choice and true-false
                        if (userResponse && userResponse[0] === correctResponse[0]) {
                            questionScore = 1;
                        }
                    }
                    score += questionScore;
                    feedback += `\n`;
                });
            
                const finalScore = Math.max(0, Math.round(score));
                let comprehensionLevel = '';
                let testStatus = 'Reprobado';
            
                if (finalScore >= 18) {
                    comprehensionLevel = '¬°Excelente! Tienes un Nivel B√°sico-Alto a Intermedio (A2/B1). ¬°Est√°s listo para el siguiente nivel!';
                    testStatus = 'Aprobado';
                } else if (finalScore >= 12) {
                    comprehensionLevel = '¬°Muy bien! Tienes un Nivel B√°sico-Intermedio (A1). Con un poco m√°s de pr√°ctica, alcanzar√°s tu meta.';
                    testStatus = 'Aprobado';
                } else {
                    comprehensionLevel = '¬°Buen inicio! Tienes un Nivel B√°sico (A1-). No te desanimes, ¬°todos empezamos por aqu√≠!';
                }
            
                return { finalScore, comprehensionLevel, testStatus, feedback };
            }
            
            function finishQuiz() {
                clearInterval(timerInterval);
                saveCurrentAnswer();
                const quizEndTime = new Date();
                const responseTime = (quizEndTime - quizStartTime) / 1000;
                
                const { finalScore, comprehensionLevel, testStatus, feedback } = gradeQuiz();
        
                const templateParams = {
                    user_full_name: currentUserFullName,
                    user_email: currentUserEmail,
                    response_time: formatElapsedTime(responseTime),
                    score: finalScore,
                    comprehension_level: comprehensionLevel,
                    test_status: testStatus,
                    full_feedback: feedback,
                    current_date: getFormattedDate()
                };
        
                db.collection("quizResults").add({
                    email: currentUserEmail,
                    fullName: currentUserFullName,
                    score: finalScore,
                    comprehensionLevel: comprehensionLevel,
                    testStatus: testStatus,
                    responseTime: responseTime,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log("Resultados del quiz guardados en Firestore.");
                    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_RESULTADOS, templateParams);
                })
                .catch(function(error) {
                    console.log('FAILED...', error);
                })
                .finally(() => {
                    const finalMessage = document.getElementById('final-thanks-message');
                    finalMessage.classList.remove('hidden');
                    setTimeout(() => finalMessage.classList.add('show'), 10);
                    
                    document.getElementById('quiz-app-container').classList.add('hidden');
                    document.getElementById('mainNav').classList.add('hidden');
                });
            }
        
            function formatElapsedTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.round(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        
            function getFormattedDate() {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return today.toLocaleDateString('es-ES', options);
            }
        
            function generatePassword(length = 12) {
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
                let password = "";
                for (let i = 0, n = charset.length; i < length; ++i) {
                    password += charset.charAt(Math.floor(Math.random() * n));
                }
                return password;
            }
        
            document.getElementById('startLearningBtn').addEventListener('click', () => showSection('quizInstructionsSection'));
            document.getElementById('openQuizStartModalBtn').addEventListener('click', () => {
                showModal('quizStartModal');
                document.getElementById('quizAttemptsMessage').textContent = '';
            });
            document.getElementById('closeQuizStartModal').addEventListener('click', () => hideModal('quizStartModal'));
            document.getElementById('closeRegisterModal').addEventListener('click', () => hideModal('registerModal'));
            document.getElementById('closeLoginModal').addEventListener('click', () => hideModal('loginModal'));
            
            // CORREGIDO: Bot√≥n de regreso para el mensaje de inscripci√≥n
            document.getElementById('backToHomeBtn').addEventListener('click', () => {
                window.location.reload();
            });

            // CORREGIDO: Bot√≥n de regreso para el mensaje del quiz
            document.getElementById('backToHomeFromQuizBtn').addEventListener('click', () => {
                window.location.reload();
            });
            
            // =======================================================
            // INICIO: L√≥gica del Modal de Registro Corregida
            // =======================================================
            document.getElementById('registrationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                setButtonLoadingState('registrationBtnText', true);

                const nombre = document.getElementById('regNombre').value;
                const cedula = document.getElementById('regCedula').value;
                const edad = document.getElementById('regEdad').value;
                const email = document.getElementById('regEmail').value;
                const messageElement = document.getElementById('registerMessage');
                messageElement.style.display = 'none';

                const generatedPassword = generatePassword();
                
                const registrationDataWithPassword = {
                    fullName: nombre,
                    cedula: cedula,
                    edad: edad,
                    email: email,
                    password: generatedPassword, 
                    approved: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                auth.fetchSignInMethodsForEmail(email)
                    .then((signInMethods) => {
                        if (signInMethods.length === 0) {
                            return auth.createUserWithEmailAndPassword(email, generatedPassword)
                                .then((userCredential) => {
                                    const user = userCredential.user;
                                    return db.collection("pending_registrations").doc(user.uid).set(registrationDataWithPassword)
                                        .then(() => {
                                            return auth.signOut();
                                        });
                                });
                        } else {
                            return db.collection("pending_registrations").add(registrationDataWithPassword);
                        }
                    })
                    .then(() => {
                        // üí° CORRECCI√ìN CLAVE: Ocultamos el modal y mostramos el nuevo bloque de mensaje.
                        hideModal('registerModal');
                        const successMessage = document.getElementById('registration-success-message');
                        successMessage.classList.remove('hidden');
                        setTimeout(() => successMessage.classList.add('show'), 10);
                        document.getElementById('registrationForm').reset();
                    })
                    .catch((error) => {
                        console.error("Error en la inscripci√≥n:", error);
                        let errorMessage = "Ocurri√≥ un error inesperado al inscribirte. Por favor, intenta de nuevo.";
                        if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El formato del correo electr√≥nico es inv√°lido.';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = 'La contrase√±a es demasiado d√©bil.';
                        } else if (error.code === 'auth/email-already-in-use') {
                            errorMessage = 'El correo electr√≥nico ya est√° registrado. Su solicitud de inscripci√≥n ser√° procesada.';
                        } else {
                             // Mensaje de error m√°s detallado para ayudar a la depuraci√≥n.
                            errorMessage = `Ocurri√≥ un error inesperado: ${error.message}. Por favor, revisa las reglas de seguridad de Firestore.`;
                        }
                        messageElement.textContent = errorMessage;
                        messageElement.classList.add('text-red-500');
                        messageElement.classList.remove('text-green-500');
                        messageElement.style.display = 'block';
                    })
                    .finally(() => {
                        setButtonLoadingState('registrationBtnText', false);
                    });
            });
            // =======================================================
            // FIN: L√≥gica del Modal de Registro Corregida
            // =======================================================
        
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                setButtonLoadingState('loginBtnText', true);
            
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const messageElement = document.getElementById('loginMessage');
                messageElement.style.display = 'none'; // Oculta el mensaje anterior al iniciar

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        // El `onAuthStateChanged` se encargar√° del resto (mostrar el aula virtual)
                        hideModal('loginModal');
                        setButtonLoadingState('loginBtnText', false);
                    })
                    .catch((error) => {
                        // Mejor manejo de errores para el inicio de sesi√≥n
                        let errorMessage = "Credenciales incorrectas. Por favor, revisa tu correo y contrase√±a.";
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            errorMessage = 'Correo o contrase√±a incorrectos. Por favor, int√©ntalo de nuevo.';
                        }
                        messageElement.textContent = errorMessage;
                        messageElement.style.display = 'block';
                        setButtonLoadingState('loginBtnText', false);
                    });
            });

            document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
                const email = document.getElementById('loginEmail').value;
                if (email) {
                    auth.sendPasswordResetEmail(email)
                        .then(() => {
                            alert('Se ha enviado un correo para restablecer tu contrase√±a. Revisa tu bandeja de entrada.');
                        })
                        .catch((error) => {
                            alert('No se pudo enviar el correo de restablecimiento. Por favor, verifica la direcci√≥n de correo.');
                        });
                } else {
                    alert('Por favor, ingresa tu correo electr√≥nico para restablecer la contrase√±a.');
                }
            });
        
            document.getElementById('quizStartForm').addEventListener('submit', function(e) {
                e.preventDefault();
                setButtonLoadingState('quizStartBtnText', true);
        
                const fullName = document.getElementById('quizNombre').value;
                const email = document.getElementById('quizEmail').value;
                const quizAttemptsMessage = document.getElementById('quizAttemptsMessage');
                
                db.collection("quizResults").where("email", "==", email).get()
                    .then(querySnapshot => {
                        const attempts = querySnapshot.size;
                        if (attempts >= 2) {
                            quizAttemptsMessage.textContent = 'Has alcanzado el n√∫mero m√°ximo de intentos (2).';
                            quizAttemptsMessage.classList.remove('hidden');
                            setButtonLoadingState('quizStartBtnText', false);
                        } else {
                            currentUserEmail = email;
                            currentUserFullName = fullName;
                            hideModal('quizStartModal');
                            startLevelingQuiz();
                        }
                    })
                    .catch(error => {
                        console.error("Error al verificar intentos:", error);
                        quizAttemptsMessage.textContent = 'Ocurri√≥ un error. Por favor, intenta de nuevo.';
                        quizAttemptsMessage.classList.remove('hidden');
                        setButtonLoadingState('quizStartBtnText', false);
                    });
            });
        });
    </script>
</body>
</html>
